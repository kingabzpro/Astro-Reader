---
import type { APIContext } from 'astro';
import { getReadingProgress, upsertReadingProgress } from '../../lib/database';

export async function POST(context: APIContext) {
	const { request, locals } = context;
	const { bookId, chapterId } = await request.json();

	const userId = locals.user?.id;

	console.log('POST /api/progress:', { userId, bookId, chapterId });

	if (!userId || !bookId || !chapterId) {
		console.log('Bad request: missing fields', { userId, bookId, chapterId });
		return new Response(JSON.stringify({ error: 'Bad request', userId, bookId, chapterId }), { status: 400 });
	}

	try {
		await upsertReadingProgress(userId, {
			bookId,
			chapterId,
			scrollPosition: 0, // Always save 0, just tracking which chapter
		});
		console.log('Progress saved successfully');
		return new Response(JSON.stringify({ success: true }), {
			headers: { 'Content-Type': 'application/json' },
			status: 200
		});
	} catch (error) {
		console.error('Progress save error:', error);
		return new Response(JSON.stringify({ error: (error as Error).message }), {
			headers: { 'Content-Type': 'application/json' },
			status: 500
		});
	}
}

export async function GET(context: APIContext) {
	const { url, locals } = context;
	const bookId = url.searchParams.get('book');
	const chapterId = url.searchParams.get('chapter');

	const userId = locals.user?.id;

	console.log('GET /api/progress:', { userId, bookId, chapterId });

	if (!userId || !bookId || !chapterId) {
		return new Response('Bad request', { status: 400 });
	}

	try {
		const progress = await getReadingProgress(userId, bookId, chapterId);

		if (!progress) {
			console.log('No progress found');
			return new Response('Not found', { status: 404 });
		}

		console.log('Progress found:', progress);
		return new Response(JSON.stringify(progress), {
			headers: { 'Content-Type': 'application/json' },
		});
	} catch (error) {
		console.error('Progress get error:', error);
		return new Response((error as Error).message, { status: 500 });
	}
}
---
