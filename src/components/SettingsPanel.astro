---
interface Props {
  settings?: {
    fontSize: string;
    lineHeight: string;
    contentWidth: string;
    theme: string;
    fontFamily: string;
  } | null;
}

const { settings } = Astro.props;

const fontSize = settings ? parseFloat(settings.fontSize) : 18;
const lineHeight = settings ? parseFloat(settings.lineHeight) : 1.6;
const contentWidth = settings ? parseFloat(settings.contentWidth) : 720;
const theme = settings?.theme || 'system';
const fontFamily = settings?.fontFamily || 'sans-serif';
---

<div class="settings-container">
  <h1 class="settings-title">Reading Settings</h1>
  <p class="settings-subtitle">Customize how your books look</p>

  <div class="settings-card">
    <!-- Font Size -->
    <div class="setting-item">
      <div class="setting-header">
        <label class="setting-name">Font Size</label>
        <span class="setting-value" id="font-size-display">{fontSize}px</span>
      </div>
      <input
        type="range"
        min="14"
        max="24"
        step="1"
        value={fontSize}
        id="font-size"
        class="setting-slider"
      />
    </div>

    <!-- Line Height -->
    <div class="setting-item">
      <div class="setting-header">
        <label class="setting-name">Line Height</label>
        <span class="setting-value" id="line-height-display">{lineHeight}</span>
      </div>
      <input
        type="range"
        min="1.4"
        max="2.0"
        step="0.1"
        value={lineHeight}
        id="line-height"
        class="setting-slider"
      />
    </div>

    <!-- Content Width -->
    <div class="setting-item">
      <div class="setting-header">
        <label class="setting-name">Content Width</label>
        <span class="setting-value" id="width-display">{contentWidth}px</span>
      </div>
      <input
        type="range"
        min="500"
        max="900"
        step="20"
        value={contentWidth}
        id="content-width"
        class="setting-slider"
      />
    </div>

    <hr class="setting-divider" />

    <!-- Font Family -->
    <div class="setting-item">
      <label class="setting-name">Font Family</label>
      <div class="button-group">
        <button class="option-button" data-font="sans-serif">
          <span class="button-text">Sans-Serif</span>
        </button>
        <button class="option-button" data-font="serif">
          <span class="button-text serif-preview">Serif</span>
        </button>
      </div>
    </div>

    <!-- Theme -->
    <div class="setting-item">
      <label class="setting-name">Theme</label>
      <div class="button-group">
        <button class="option-button" data-theme="light">
          <span class="button-text">Light</span>
        </button>
        <button class="option-button" data-theme="dark">
          <span class="button-text">Dark</span>
        </button>
        <button class="option-button" data-theme="sepia">
          <span class="button-text">Sepia</span>
        </button>
        <button class="option-button" data-theme="system">
          <span class="button-text">System</span>
        </button>
      </div>
    </div>
  </div>

  <p class="settings-note">Changes apply instantly to your reading experience</p>
</div>

<div class="toast" id="toast">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <polyline points="20 6 9 17 4 12"/>
  </svg>
  <span>Settings saved!</span>
</div>

<style>
  .settings-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 1rem;
  }

  .settings-title {
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    color: #1e1b4b;
  }

  .settings-subtitle {
    color: #64748b;
    margin: 0 0 2rem 0;
    font-size: 1rem;
  }

  .settings-card {
    background: #ffffff;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid #e2e8f0;
  }

  .setting-item {
    margin-bottom: 1.5rem;
  }

  .setting-item:last-of-type {
    margin-bottom: 0;
  }

  .setting-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .setting-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: #1e1b4b;
  }

  .setting-value {
    background: #f1f5f9;
    color: #6366f1;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .setting-slider {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: #e2e8f0;
    outline: none;
    cursor: pointer;
    appearance: none;
  }

  .setting-slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #6366f1;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(99, 102, 241, 0.4);
    transition: transform 0.15s;
  }

  .setting-slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
  }

  .setting-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #6366f1;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 6px rgba(99, 102, 241, 0.4);
  }

  .setting-divider {
    border: none;
    border-top: 1px solid #e2e8f0;
    margin: 1.5rem 0;
  }

  .button-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 0.5rem;
  }

  .option-button {
    padding: 0.75rem 1rem;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: #475569;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .option-button:hover {
    border-color: #6366f1;
    background: #f1f5f9;
  }

  .option-button.active {
    background: #6366f1;
    border-color: #6366f1;
    color: white;
  }

  .serif-preview {
    font-family: Georgia, serif;
  }

  .settings-note {
    text-align: center;
    color: #64748b;
    font-size: 0.875rem;
    margin-top: 1.5rem;
  }

  .toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: #10b981;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 500;
    transform: translateY(150%);
    transition: transform 0.3s ease;
    z-index: 1000;
  }

  .toast.show {
    transform: translateY(0);
  }

  /* Dark theme support */
  :global([data-theme="dark"]) .settings-title {
    color: #f8fafc;
  }

  :global([data-theme="dark"]) .settings-subtitle,
  :global([data-theme="dark"]) .settings-note {
    color: #94a3b8;
  }

  :global([data-theme="dark"]) .settings-card {
    background: #1e293b;
    border-color: #334155;
  }

  :global([data-theme="dark"]) .setting-name {
    color: #f8fafc;
  }

  :global([data-theme="dark"]) .setting-value {
    background: #334155;
    color: #818cf8;
  }

  :global([data-theme="dark"]) .setting-slider {
    background: #334155;
  }

  :global([data-theme="dark"]) .setting-divider {
    border-top-color: #334155;
  }

  :global([data-theme="dark"]) .option-button {
    background: #334155;
    border-color: #475569;
    color: #cbd5e1;
  }

  :global([data-theme="dark"]) .option-button:hover {
    border-color: #818cf8;
    background: #475569;
  }

  /* Sepia theme support */
  :global([data-theme="sepia"]) .settings-title {
    color: #5c4b37;
  }

  :global([data-theme="sepia"]) .settings-subtitle,
  :global([data-theme="sepia"]) .settings-note {
    color: #7d6a54;
  }

  :global([data-theme="sepia"]) .settings-card {
    background: #fefcf8;
    border-color: #e6dcc8;
  }

  :global([data-theme="sepia"]) .setting-name {
    color: #5c4b37;
  }

  :global([data-theme="sepia"]) .setting-value {
    background: #f5f0e6;
    color: #d97706;
  }

  :global([data-theme="sepia"]) .setting-slider {
    background: #e6dcc8;
  }

  :global([data-theme="sepia"]) .setting-divider {
    border-top-color: #e6dcc8;
  }

  :global([data-theme="sepia"]) .option-button {
    background: #f5f0e6;
    border-color: #e6dcc8;
    color: #5c4b37;
  }

  :global([data-theme="sepia"]) .option-button:hover {
    border-color: #d97706;
    background: #e6dcc8;
  }

  @media (max-width: 640px) {
    .settings-container {
      padding: 0.5rem;
    }

    .settings-card {
      padding: 1rem;
    }

    .button-group {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<script define:vars={{ theme: theme.toString(), fontFamily: fontFamily.toString() }}>
  let saveTimeout = null;

  async function saveSettings(newSettings) {
    if (saveTimeout) clearTimeout(saveTimeout);

    saveTimeout = window.setTimeout(async () => {
      try {
        await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newSettings),
        });

        // Show toast
        const toast = document.getElementById('toast');
        if (toast) {
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), 2000);
        }
      } catch (error) {
        console.error('Failed to save settings:', error);
      }
    }, 500);
  }

  // Font size
  const fontSizeInput = document.getElementById('font-size');
  fontSizeInput?.addEventListener('input', (e) => {
    const value = e.target.value;
    document.getElementById('font-size-display').textContent = `${value}px`;
    document.documentElement.style.setProperty('--reading-font-size', `${value}px`);
    saveSettings({ fontSize: parseInt(value) });
  });

  // Line height
  const lineHeightInput = document.getElementById('line-height');
  lineHeightInput?.addEventListener('input', (e) => {
    const value = e.target.value;
    document.getElementById('line-height-display').textContent = value;
    document.documentElement.style.setProperty('--reading-line-height', value);
    saveSettings({ lineHeight: parseFloat(value) });
  });

  // Content width
  const widthInput = document.getElementById('content-width');
  widthInput?.addEventListener('input', (e) => {
    const value = e.target.value;
    document.getElementById('width-display').textContent = `${value}px`;
    document.documentElement.style.setProperty('--reading-content-width', `${value}px`);
    saveSettings({ contentWidth: parseInt(value) });
  });

  // Font family
  const fontButtons = document.querySelectorAll('.option-button[data-font]');
  fontButtons.forEach(btn => {
    if (btn.getAttribute('data-font') === fontFamily) {
      btn.classList.add('active');
    }

    btn.addEventListener('click', () => {
      const selectedFont = btn.getAttribute('data-font');

      fontButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      document.documentElement.style.setProperty('--reading-font-family', selectedFont);
      saveSettings({ fontFamily: selectedFont });
    });
  });

  // Theme
  const themeButtons = document.querySelectorAll('.option-button[data-theme]');
  themeButtons.forEach(btn => {
    if (btn.getAttribute('data-theme') === theme) {
      btn.classList.add('active');
    }

    btn.addEventListener('click', () => {
      const selectedTheme = btn.getAttribute('data-theme');

      themeButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const resolvedTheme = selectedTheme === 'system'
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
        : selectedTheme;

      document.documentElement.setAttribute('data-theme', resolvedTheme);
      saveSettings({ theme: selectedTheme });
    });
  });
</script>
