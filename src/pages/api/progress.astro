import type { APIRoute } from 'astro';
import { saveProgress, getReadingProgress } from '../../lib/database';

export const POST: APIRoute = async ({ request, locals }) => {
	const body = await request.json();
	const { bookId, chapterId } = body;
	const userId = locals.user?.id;

	if (!userId || !bookId || !chapterId) {
		return new Response(JSON.stringify({ error: 'Missing required fields' }), { status: 400 });
	}

	try {
		await saveProgress(userId, bookId, chapterId);
		return new Response(JSON.stringify({ success: true }));
	} catch (error) {
		return new Response(JSON.stringify({ error: (error as Error).message }), { status: 500 });
	}
};

export const GET: APIRoute = async ({ url, locals }) => {
	const bookId = url.searchParams.get('book');
	const chapterId = url.searchParams.get('chapter');
	const userId = locals.user?.id;

	if (!userId || !bookId || !chapterId) {
		return new Response('Missing required fields', { status: 400 });
	}

	try {
		const progress = await getReadingProgress(userId, bookId, chapterId);
		if (!progress) {
			return new Response('Not found', { status: 404 });
		}
		return new Response(JSON.stringify(progress));
	} catch (error) {
		return new Response((error as Error).message, { status: 500 });
	}
};
