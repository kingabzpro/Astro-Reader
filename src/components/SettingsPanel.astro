---
interface Props {
  settings?: {
    fontSize: string;
    lineHeight: string;
    contentWidth: string;
    theme: string;
  } | null;
}

const { settings } = Astro.props;

const fontSize = settings ? parseFloat(settings.fontSize) : 18;
const lineHeight = settings ? parseFloat(settings.lineHeight) : 1.6;
const contentWidth = settings ? parseFloat(settings.contentWidth) : 720;
const theme = settings?.theme || 'system';
---

<div class="settings-panel">
  <h2>Reader Settings</h2>

  <div class="setting-group">
    <label>
      <span class="setting-label">
        Font Size
        <span class="setting-value" id="font-size-value">{fontSize}px</span>
      </span>
      <input
        type="range"
        min="14"
        max="24"
        step="1"
        value={fontSize}
        id="font-size"
      />
    </label>
  </div>

  <div class="setting-group">
    <label>
      <span class="setting-label">
        Line Height
        <span class="setting-value" id="line-height-value">{lineHeight}</span>
      </span>
      <input
        type="range"
        min="1.4"
        max="2.0"
        step="0.1"
        value={lineHeight}
        id="line-height"
      />
    </label>
  </div>

  <div class="setting-group">
    <label>
      <span class="setting-label">
        Content Width
        <span class="setting-value" id="width-value">{contentWidth}px</span>
      </span>
      <input
        type="range"
        min="500"
        max="900"
        step="20"
        value={contentWidth}
        id="content-width"
      />
    </label>
  </div>

  <div class="setting-group">
    <label class="setting-label">Theme</label>
    <div class="theme-selector">
      <button class="theme-btn" data-theme="light">Light</button>
      <button class="theme-btn" data-theme="dark">Dark</button>
      <button class="theme-btn" data-theme="sepia">Sepia</button>
      <button class="theme-btn" data-theme="system">System</button>
    </div>
  </div>
</div>

<style>
  .settings-panel {
    padding: 2rem;
    background: var(--card-bg);
    border-radius: 12px;
    max-width: 600px;
  }

  .settings-panel h2 {
    margin: 0 0 2rem 0;
    font-size: 1.5rem;
  }

  .setting-group {
    margin-bottom: 2rem;
  }

  .setting-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    font-weight: 500;
  }

  .setting-value {
    color: var(--accent-color);
    font-family: monospace;
  }

  label input[type="range"] {
    width: 100%;
    cursor: pointer;
    height: 6px;
    border-radius: 3px;
    background: var(--border-color);
    appearance: none;
  }

  label input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent-color);
    cursor: pointer;
  }

  label input[type="range"]::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent-color);
    cursor: pointer;
    border: none;
  }

  .theme-selector {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .theme-btn {
    flex: 1;
    min-width: 80px;
    padding: 0.75rem 1rem;
    background: var(--bg-color);
    border: 2px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
  }

  .theme-btn:hover {
    border-color: var(--accent-color);
  }

  .theme-btn.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
  }
</style>

<script define:vars={{ theme: theme.toString() }}>
  // Debounced save function
  let saveTimeout = null;

  async function saveSettings(newSettings) {
    if (saveTimeout) clearTimeout(saveTimeout);

    saveTimeout = window.setTimeout(async () => {
      try {
        await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newSettings),
        });
      } catch (error) {
        console.error('Failed to save settings:', error);
      }
    }, 1000);
  }

  // Font size handler
  const fontSizeInput = document.getElementById('font-size');
  fontSizeInput?.addEventListener('input', (e) => {
    const value = e.target.value;
    document.getElementById('font-size-value').textContent = `${value}px`;
    document.documentElement.style.setProperty('--reading-font-size', `${value}px`);
    saveSettings({ font_size: parseInt(value) });
  });

  // Line height handler
  const lineHeightInput = document.getElementById('line-height');
  lineHeightInput?.addEventListener('input', (e) => {
    const value = e.target.value;
    document.getElementById('line-height-value').textContent = value;
    document.documentElement.style.setProperty('--reading-line-height', value);
    saveSettings({ line_height: parseFloat(value) });
  });

  // Content width handler
  const widthInput = document.getElementById('content-width');
  widthInput?.addEventListener('input', (e) => {
    const value = e.target.value;
    document.getElementById('width-value').textContent = `${value}px`;
    document.documentElement.style.setProperty('--reading-content-width', `${value}px`);
    saveSettings({ content_width: parseInt(value) });
  });

  // Theme handlers
  const themeButtons = document.querySelectorAll('.theme-btn');
  themeButtons.forEach(btn => {
    // Set initial active state
    if (btn.getAttribute('data-theme') === theme) {
      btn.classList.add('active');
    }

    btn.addEventListener('click', () => {
      const selectedTheme = btn.getAttribute('data-theme');

      // Update active state
      themeButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Apply theme
      const resolvedTheme = selectedTheme === 'system'
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
        : selectedTheme;

      document.documentElement.setAttribute('data-theme', resolvedTheme);
      saveSettings({ theme: selectedTheme });
    });
  });
</script>
