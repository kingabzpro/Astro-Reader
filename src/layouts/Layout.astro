---
import { getUserSettings } from '../lib/database';

interface Props {
  title?: string;
}

const { title = 'Book Reader' } = Astro.props;

// Get user settings
let settings = null;
let theme = 'system';
let fontSize = 18;
let lineHeight = 1.6;
let contentWidth = 720;

if (Astro.locals.session && Astro.locals.user) {
  settings = await getUserSettings(Astro.locals.user.id);

  if (settings) {
    theme = settings.theme || 'system';
    fontSize = parseFloat(settings.fontSize || '18');
    lineHeight = parseFloat(settings.lineHeight || '1.6');
    contentWidth = parseFloat(settings.contentWidth || '720');
  }
}

// Resolve theme
const resolvedTheme = theme === 'system'
  ? (Astro.request.headers.get('sec-ch-prefers-color-scheme') || 'light')
  : theme;
---

<!DOCTYPE html>
<html lang="en" data-theme={resolvedTheme}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
  </head>
  <body>
    <nav class="minimal-nav">
      <a href="/">Library</a>
      <div class="nav-right">
        {Astro.locals.session && (
          <>
            <a href="/dashboard">Continue Reading</a>
            <a href="/settings">Settings</a>
            <a href="/logout">Logout</a>
          </>
        )}
      </div>
    </nav>

    <main class="main-content">
      <slot />
    </main>

    <style is:global define:vars={{
      fontSize: `${fontSize}px`,
      lineHeight: lineHeight.toString(),
      contentWidth: `${contentWidth}px`,
    }}>
      :root {
        --reading-font-size: var(--fontSize);
        --reading-line-height: var(--lineHeight);
        --reading-content-width: var(--contentWidth);

        /* Light theme */
        --bg-color: #ffffff;
        --text-color: #1a1a1a;
        --border-color: #e5e5e5;
        --card-bg: #f9f9f9;
        --accent-color: #0066cc;
        --accent-hover: #0052a3;
      }

      [data-theme="dark"] {
        --bg-color: #1a1a1a;
        --text-color: #e5e5e5;
        --border-color: #333333;
        --card-bg: #2a2a2a;
        --accent-color: #66b3ff;
        --accent-hover: #4d94cc;
      }

      [data-theme="sepia"] {
        --bg-color: #f4ecd8;
        --text-color: #5c4b37;
        --border-color: #d4c4a8;
        --card-bg: #ebe3d1;
        --accent-color: #8b4513;
        --accent-hover: #6b3410;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        line-height: var(--reading-line-height);
        margin: 0;
        padding: 0;
        transition: background 0.3s, color 0.3s;
      }

      a {
        color: var(--accent-color);
        text-decoration: none;
      }

      a:hover {
        color: var(--accent-hover);
      }
    </style>

    <style>
      .minimal-nav {
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-color);
        border-bottom: 1px solid var(--border-color);
        z-index: 100;
      }

      .nav-right {
        display: flex;
        gap: 1.5rem;
        align-items: center;
      }

      .nav-right a {
        color: var(--text-color);
        text-decoration: none;
        font-size: 0.95rem;
      }

      .nav-right a:hover {
        color: var(--accent-color);
      }

      .main-content {
        min-height: calc(100vh - 65px);
      }
    </style>
  </body>
</html>
